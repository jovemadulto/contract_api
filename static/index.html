<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Contratos</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
        }
        h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        .form-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        input[type="text"],
        input[type="password"],
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; /* Important for padding */
        }
        input[type="file"] {
            padding: 5px;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }
        #upload-section {
            display: none; /* Hidden by default */
        }
        #results-section {
            padding: 30px;
        }
        #results-section h2 {
            margin-top: 0;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        #message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .message-success {
            background-color: #e6f7ec;
            color: #006421;
            border: 1px solid #b7ebc9;
        }
        .message-error {
            background-color: #fdecea;
            color: #a40000;
            border: 1px solid #f9c6c6;
        }
        pre {
            background-color: #2d2d2d;
            color: #f1f1f1;
            padding: 20px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #results-output {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0;
            background-color: #fdfdfd;
        }
        #results-output p {
            /* This styles the "Aguardando..." text */
            padding: 20px;
            margin: 0;
            color: #777;
        }
        .results-list {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        .results-list li {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            word-break: break-word;
        }
        .results-list li:last-child {
            border-bottom: none;
        }
        .results-list li strong {
            display: block;
            color: #333;
            margin-right: 20px;
            flex-shrink: 0;
            min-width: 150px;
        }
        .results-list li span {
            text-align: right;
            color: #555;
        }
        
        /* Nested list for obligations */
        .results-list li ul {
            list-style-type: disc;
            margin: 5px 0 0 20px;
            padding: 0;
            width: 100%;
            text-align: left;
        }
        .results-list li ul li {
            padding: 5px;
            border: none;
            display: list-item;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Analisador de Contratos com IA</h1>
        </div>

        <div id="login-section" class="form-section">
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Usuário</label>
                    <input type="text" id="username" value="admin" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" value="admin" required>
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

        <div id="upload-section" class="form-section">
            <form id="upload-form">
                <div class="form-group">
                    <label for="file-input">Selecione o Contrato (.pdf ou .docx)</label>
                    <input type="file" id="file-input" accept=".pdf,.docx" required>
                </div>
                <button type="submit" id="upload-button">Analisar Contrato</button>
            </form>
        </div>

        <div id="results-section">
            <h2>Resultados da Análise</h2>
            <div id="message"></div>
            <div id="results-output">
                <p>Aguardando envio do arquivo...</p>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const API_BASE_URL = "http://127.0.0.1:8000"; // IMPORTANT: Change this if your API runs elsewhere
        
        // --- State ---
        let jwtToken = null;

        // --- Selectors ---
        const loginSection = document.getElementById("login-section");
        const uploadSection = document.getElementById("upload-section");
        const loginForm = document.getElementById("login-form");
        const uploadForm = document.getElementById("upload-form");
        const fileInput = document.getElementById("file-input");
        const uploadButton = document.getElementById("upload-button");
        const messageEl = document.getElementById("message");
        const resultsOutput = document.getElementById("results-output");

        // --- Event Listeners ---

        /**
         * 1. Handle Login
         */
        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            showMessage("", "clear");
            
            const username = loginForm.username.value;
            const password = loginForm.password.value;

            // FastAPI's OAuth2PasswordRequestForm expects form-urlencoded data
            const formData = new URLSearchParams();
            formData.append("username", username);
            formData.append("password", password);

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || "Falha no login");
                }
                
                // --- Login Success ---
                jwtToken = data.access_token;
                showMessage("Login realizado com sucesso!", "success");
                
                // Hide login form, show upload form
                loginSection.style.display = "none";
                uploadSection.style.display = "block";

            } catch (error) {
                console.error("Login error:", error);
                showMessage(`Erro no login: ${error.message}`, "error");
            }
        });

        /**
         * 2. Handle File Upload
         */
        uploadForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!fileInput.files.length) {
                showMessage("Por favor, selecione um arquivo.", "error");
                return;
            }

            const file = fileInput.files[0];

            // Create FormData to send the file
            const formData = new FormData();
            formData.append("file", file); // The key "file" must match your FastAPI endpoint parameter

            setUploadButtonState(true, "Analisando..."); // Disable button

            try {
                const response = await fetch(`${API_BASE_URL}/contracts/upload`, {
                    method: "POST",
                    headers: {
                        // Add the JWT token to the Authorization header
                        "Authorization": `Bearer ${jwtToken}`
                        // "Content-Type" is set automatically by the browser for FormData
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    // Handle API errors (like 400, 404, 500)
                    throw new Error(data.detail || `Erro ${response.status} ao processar o arquivo.`);
                }

                // --- Upload Success ---
                showMessage("Contrato analisado com sucesso!", "success");
                // Display the returned JSON data
                displayResults(data);

            } catch (error) {
                console.error("Upload error:", error);
                showMessage(`Erro no upload: ${error.message}`, "error");
                resultsOutput.textContent = "Falha ao obter resultados.";
            } finally {
                setUploadButtonState(false, "Analisar Contrato"); // Re-enable button
            }
        });

        // --- Helper Functions ---

        /**
         * Shows a status message to the user.
         * @param {string} text - The message to display.
         * @param {'success' | 'error' | 'clear'} type - The message type.
         */
        function showMessage(text, type) {
            messageEl.textContent = text;
            messageEl.className = type === "clear" ? "" : `message-${type}`;
            messageEl.style.display = (type === "clear" || !text) ? "none" : "block";
        }

        /**
         * Manages the upload button's state.
         * @param {boolean} disabled - Whether to disable the button.
         * @param {string} text - The text to display on the button.
         */
        function setUploadButtonState(disabled, text) {
            uploadButton.disabled = disabled;
            uploadButton.textContent = text;
        }
        // --- Helper Functions ---
        
        /**
         * Displays the contract data as a pretty HTML list.
         * @param {object} data - The JSON data from the API.
         */
         function displayResults(data) {
            // Map of internal keys to pretty, human-readable labels
            const labels = {
                id: "ID da Análise",
                filename: "Nome do Arquivo",
                contratante: "Contratante",
                contratado: "Contratado",
                valor_bens: "Valor dos Bens",
                obrigacoes_contratante: "Obrigações (Contratante)",
                obrigacoes_contratada: "Obrigações (Contratada)",
                objeto: "Objeto do Contrato",
                vigencia: "Vigência",
                clausula_rescisao: "Cláusula de Rescisão"
            };

            // List of all keys that the backend now returns as stringified JSON lists
            const listKeys = [
                'contratante',
                'contratado',
                'objeto',
                'obrigacoes_contratante',
                'obrigacoes_contratada'
            ];
            
            const resultsList = document.createElement("ul");
            resultsList.className = "results-list";
            
            // Clear previous results
            resultsOutput.innerHTML = ""; 

            for (const [key, value] of Object.entries(data)) {
                // Skip keys we don't want to display
                if (!labels[key]) continue; 

                const li = document.createElement("li");
                const label = labels[key]; // We know the key exists
                
                let valueHtml;

                // Check if the key is one of the fields that should be a list
                if (listKeys.includes(key) && value) {
                    try {
                        const items = JSON.parse(value);
                        
                        if (Array.isArray(items) && items.length > 0) {
                            
                            // If it's a list with only ONE item (e.g., contratante),
                            // display it as a simple string for a cleaner UI.
                            if (items.length === 1) {
                                valueHtml = `<span>${items[0]}</span>`;
                                li.innerHTML = `<strong>${label}</strong> ${valueHtml}`;
                            } else {
                                // If it's a list with MULTIPLE items (e.g., obrigações),
                                // build a proper nested list.
                                const nestedList = items.map(item => `<li>${item}</li>`).join("");
                                valueHtml = `<ul>${nestedList}</ul>`;
                                // Use list-specific layout
                                li.innerHTML = `<strong>${label}</strong> ${valueHtml}`;
                            }

                        } else {
                            // Handle empty list '[]'
                            valueHtml = `<span>Não informado</span>`;
                            li.innerHTML = `<strong>${label}</strong> ${valueHtml}`;
                        }
                    } catch (e) {
                        // Fallback if JSON.parse fails
                        valueHtml = `<span>${value}</span>`; 
                        li.innerHTML = `<strong>${label}</strong> ${valueHtml}`;
                    }
                } else {
                    // This is for standard, non-list key-value pairs (like 'valor_bens')
                    valueHtml = `<span>${value || 'Não informado'}</span>`;
                    li.innerHTML = `<strong>${label}</strong> ${valueHtml}`;
                }
                
                resultsList.appendChild(li);
            }
            
            resultsOutput.appendChild(resultsList);
        }
        
        /**
         * Shows a status message to the user.
         * ... (your existing showMessage function) ...
         */

        // --- Initial Setup ---
        showMessage("", "clear"); // Clear any messages on load

    </script>
</body>
</html>